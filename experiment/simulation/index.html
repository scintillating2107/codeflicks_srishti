<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Lab - Flow Rate Measurement using V-Notch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .water-animation {
            background: linear-gradient(0deg, rgba(34, 193, 195, 0.7) 0%, rgba(45, 120, 253, 0.7) 100%);
            background-size: 400% 400%;
            animation: waterFlow 8s ease infinite;
            animation-play-state: running;
        }
        @keyframes waterFlow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .notch {
            clip-path: polygon(0 0, 100% 0, 50% 100%);
        }
        .water-level {
            transition: height 0.8s ease-out;
        }
        .channel-side {
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        .metal-texture {
            background: linear-gradient(135deg, #b1b1b1 0%, #9e9e9e 50%, #757575 51%, #616161 100%);
        }
        .water-surface {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
        .horizontal-flow {
            animation: horizontalWaterFlow 3s linear infinite;
            background-size: 200% 100%;
            opacity: 0.5;
            animation-play-state: running;
        }
        @keyframes horizontalWaterFlow {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .paused-animation {
            animation-play-state: paused !important;
        }
        .water-molecule {
            position: absolute;
            border-radius: 50% / 40%;
            pointer-events: none;
            background: radial-gradient(ellipse at 40% 60%, #4fc3f7 70%, #1976d2 100%);
            box-shadow: 8px 0 12px 0 rgba(33,150,243,0.18), 0 0 2px 0 #1976d2;
            opacity: 0.32;
            filter: blur(0.2px);
            transition: opacity 0.3s;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <header class="bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-md py-4 mb-6">
    <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <div class="text-center md:text-left">
                <h1 class="text-2xl font-bold">Virtual Fluid Mechanics Lab</h1>
                <h2 class="text-sm font-medium text-blue-100 mt-1">Flow Rate Measurement using V-Notch Weir</h2>
            </div>
            <div class="mt-2 md:mt-0">
                <button id="helpBtn" class="bg-blue-800 hover:bg-blue-900 px-3 py-1.5 rounded-md flex items-center text-sm transition-colors duration-200">
                    <i class="fas fa-question-circle mr-1.5"></i> Help
                </button>
                <button id="voiceBtn" class="bg-purple-800 hover:bg-purple-900 px-3 py-1.5 rounded-md flex items-center text-sm transition-colors duration-200 ml-2">
                    <i class="fas fa-volume-up mr-1.5"></i> Voice Guide
                </button>
            </div>
        </div>
    </div>
</header>

        <!-- Main Content -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Experiment Visualization -->
            <div class="lg:col-span-2 bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Experiment Setup</h3>
                
                <div class="relative h-96 bg-gray-100 rounded-lg overflow-hidden mb-4 border-2 border-gray-300">
                    <!-- Channel base -->
                    <div class="absolute bottom-0 left-0 right-0 h-16 bg-gray-300 channel-side"></div>
                    
                    <!-- Channel sides -->
                    <div class="absolute bottom-16 left-0 w-8 h-full bg-gray-400 channel-side"></div>
                    <div class="absolute bottom-16 right-0 w-8 h-full bg-gray-400 channel-side"></div>
                    
                    <!-- V-Notch Weir -->
                    <div class="absolute bottom-16 left-1/2 transform -translate-x-1/2 w-32 h-32 flex items-end justify-center">
                        <svg id="vNotchSVG" width="100%" height="100%" viewBox="0 0 128 128">
                            <polygon id="vNotchPolygon" fill="url(#metalGradient)" stroke="#757575" stroke-width="2" />
                            <defs>
                                <linearGradient id="metalGradient" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="0%" stop-color="#b1b1b1"/>
                                    <stop offset="50%" stop-color="#9e9e9e"/>
                                    <stop offset="51%" stop-color="#757575"/>
                                    <stop offset="100%" stop-color="#616161"/>
                                </linearGradient>
                            </defs>
                        </svg>
                    </div>
                    
                    <!-- Water -->
                    <div id="water" class="absolute bottom-16 left-8 right-8 water-animation water-level" style="height: 30%;">
                        <!-- Horizontal Flow Animation -->
                        <div class="absolute top-2 left-0 right-0 h-3/4 overflow-hidden pointer-events-none">
                            <div class="horizontal-flow h-full w-[200%]" style="background: linear-gradient(90deg, rgba(34,193,195,0.5) 0%, rgba(45,120,253,0.5) 100%);"></div>
                        </div>
                        <!-- Water Molecules -->
                        <div id="moleculeContainer" class="absolute top-0 left-0 w-full h-full pointer-events-none"></div>
                        <div class="absolute top-0 left-0 right-0 h-2 water-surface"></div>
                    </div>
                    
                    <!-- Outlet flow -->
                    <div class="absolute bottom-16 right-8 w-16 h-4 overflow-hidden">
                        <div class="absolute top-0 left-0 right-0 h-full water-animation" style="clip-path: polygon(0 0, 100% 0, 80% 100%, 20% 100%);"></div>
                    </div>
                    
                    <!-- Measurement Scale -->
                    <div class="absolute right-4 top-4 bottom-16 w-8 bg-white bg-opacity-90 rounded border-2 border-gray-400 shadow-md">
                        <div class="relative h-full">
                            <div class="absolute left-0 right-0 h-px bg-red-600" style="bottom: 30%;">
                                <div class="absolute -left-10 text-xs font-mono bg-white px-1 rounded">H = <span id="hValue">0.30</span> m</div>
                            </div>
                            <div class="absolute left-0 right-0 h-px bg-gray-700" style="bottom: 0%;">
                                <div class="absolute -left-8 text-xs bg-white px-1 rounded">0</div>
                            </div>
                            <div class="absolute left-0 right-0 h-px bg-gray-500" style="bottom: 25%;">
                                <div class="absolute -left-8 text-xs bg-white px-1 rounded">0.25</div>
                            </div>
                            <div class="absolute left-0 right-0 h-px bg-gray-500" style="bottom: 50%;">
                                <div class="absolute -left-8 text-xs bg-white px-1 rounded">0.50</div>
                            </div>
                            <div class="absolute left-0 right-0 h-px bg-gray-500" style="bottom: 75%;">
                                <div class="absolute -left-8 text-xs bg-white px-1 rounded">0.75</div>
                            </div>
                            <div class="absolute left-0 right-0 h-px bg-gray-700" style="bottom: 100%;">
                                <div class="absolute -left-8 text-xs bg-white px-1 rounded">1.00</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Flow direction indicators -->
                    <div class="absolute bottom-24 left-12 animate-pulse">
                        <i class="fas fa-arrow-right text-blue-700 text-2xl"></i>
                    </div>
                </div>
                
                <!-- Controls -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-100 p-4 rounded-lg border border-gray-300">
                        <label for="headControl" class="block text-sm font-medium text-gray-700 mb-1">Head Control (H)</label>
                        <input type="range" id="headControl" min="10" max="80" value="30" class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs text-gray-600 mt-1">
                            <span>0.1 m</span>
                            <span>0.45 m</span>
                            <span>0.8 m</span>
                        </div>
                        <div class="mt-2 flex justify-center">
                            <button id="fineTuneMinus" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-3 rounded-l">
                                <i class="fas fa-minus"></i>
                            </button>
                            <div class="bg-white px-4 py-1 border-t border-b border-gray-300 text-sm">
                                Fine Tune
                            </div>
                            <button id="fineTunePlus" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-1 px-3 rounded-r">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="bg-gray-100 p-4 rounded-lg border border-gray-300">
                        <label for="notchAngle" class="block text-sm font-medium text-gray-700 mb-1">Notch Angle (θ)</label>
                        <select id="notchAngle" class="w-full p-2 border border-gray-300 rounded-md bg-white">
                            <option value="30">30°</option>
                            <option value="45">45°</option>
                            <option value="60" selected>60°</option>
                            <option value="90">90°</option>
                            <option value="120">120°</option>
                        </select>
                        <div class="mt-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" id="autoCalculate" class="form-checkbox" checked>
                                <span class="ml-2 text-sm">Auto-calculate</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="bg-gray-100 p-4 rounded-lg border border-gray-300 space-y-2">
                        <button id="startBtn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md flex items-center justify-center">
                            <i class="fas fa-play mr-2"></i> Start Simulation
                        </button>
                        <button id="addDataBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md flex items-center justify-center">
                            <i class="fas fa-plus mr-2"></i> Record Data
                        </button>
                        <button id="resetBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-md flex items-center justify-center">
                            <i class="fas fa-redo mr-2"></i> Reset
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Calculations Panel -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Measurements & Calculations</h3>
                
                <div class="space-y-4">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="font-medium text-blue-800 mb-2">Parameters</h4>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <div>Notch Angle (θ):</div>
                            <div class="font-mono" id="displayAngle">60°</div>
                            <div>Head (H):</div>
                            <div class="font-mono" id="displayH">0.30 m</div>
                            <div>Gravity (g):</div>
                            <div class="font-mono">9.81 m/s²</div>
                            <div>Discharge Coeff. (C<sub>d</sub>):</div>
                            <div class="font-mono">0.62</div>
                        </div>
                    </div>
                    
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <h4 class="font-medium text-green-800 mb-2">Calculations</h4>
                        <div class="text-sm space-y-2">
                            <div>
                                <div class="font-medium">Theoretical Discharge (Q):</div>
                                <div class="font-mono text-xs bg-white p-2 rounded mt-1 border border-gray-200" id="theoreticalQ">
                                    Q = (8/15) × C<sub>d</sub> × √(2g) × tan(θ/2) × H<sup>5/2</sup>
                                </div>
                                <div class="font-mono mt-2 text-lg font-bold text-green-700" id="calculatedQ">0.0123 m³/s</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <h4 class="font-medium text-purple-800 mb-2">Data Table</h4>
                        <div class="overflow-x-auto max-h-60 overflow-y-auto">
                            <table class="min-w-full text-xs">
                                <thead class="sticky top-0">
                                    <tr class="bg-purple-100">
                                        <th class="px-2 py-1 border">Run</th>
                                        <th class="px-2 py-1 border">H (m)</th>
                                        <th class="px-2 py-1 border">θ (°)</th>
                                        <th class="px-2 py-1 border">Q (m³/s)</th>
                                        <th class="px-2 py-1 border">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="dataTable">
                                    <!-- Data will be added here -->
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2 flex justify-between">
                            <button id="exportDataBtn" class="text-xs bg-purple-600 hover:bg-purple-700 text-white py-1 px-2 rounded">
                                <i class="fas fa-download mr-1"></i> Export
                            </button>
                            <button id="clearDataBtn" class="text-xs bg-red-600 hover:bg-red-700 text-white py-1 px-2 rounded">
                                <i class="fas fa-trash mr-1"></i> Clear
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Graph Section -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">H vs Q Relationship</h3>
            <div class="h-64">
                <canvas id="resultsChart"></canvas>
            </div>
            <div class="mt-4 text-sm text-gray-600">
                <p>The graph shows the relationship between head (H) and discharge (Q). For a V-notch weir, the relationship is Q ∝ H<sup>5/2</sup>.</p>
            </div>
        </div>
        
        <!-- Theory Section -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-xl font-semibold mb-4 text-gray-800 border-b pb-2">Theory</h3>
            <div class="prose max-w-none">
                <h4 class="text-lg font-medium text-blue-800">V-Notch Weir</h4>
                <p>A V-notch weir is a flow measurement device with a V-shaped opening used to measure small to moderate flow rates in open channels. The flow rate is determined by measuring the height of the water surface (head) above the apex of the notch.</p>
                
                <h4 class="text-lg font-medium text-blue-800 mt-4">Discharge Equation</h4>
                <p>The theoretical discharge over a V-notch weir is given by:</p>
                <div class="bg-gray-100 p-4 rounded-lg my-2 border border-gray-300">
                    Q = (8/15) × C<sub>d</sub> × √(2g) × tan(θ/2) × H<sup>5/2</sup>
                </div>
                <p>Where:</p>
                <ul class="list-disc pl-5 space-y-1">
                    <li>Q = Discharge rate (m³/s)</li>
                    <li>C<sub>d</sub> = Discharge coefficient (typically 0.58-0.62)</li>
                    <li>g = Acceleration due to gravity (9.81 m/s²)</li>
                    <li>θ = Angle of the V-notch (degrees)</li>
                    <li>H = Head above the notch apex (m)</li>
                </ul>
                
                <h4 class="text-lg font-medium text-blue-800 mt-4">Procedure</h4>
                <ol class="list-decimal pl-5 space-y-1">
                    <li>Set up the V-notch weir in the channel</li>
                    <li>Adjust the flow rate to achieve a steady flow</li>
                    <li>Measure the head (H) above the apex of the notch</li>
                    <li>Record the measurements</li>
                    <li>Calculate the discharge using the formula</li>
                    <li>Repeat for different flow rates</li>
                </ol>
            </div>
        </div>
    </div>
    
    <!-- Help Modal -->
    <div id="helpModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Virtual Lab Help</h3>
                    <button id="closeHelp" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="prose">
                    <h4 class="font-medium">How to Use This Simulator</h4>
                    <p>This virtual lab allows you to experiment with flow rate measurement using a V-notch weir. Follow these steps:</p>
                    <ol class="list-decimal pl-5 space-y-1">
                        <li>Use the <strong>Head Control</strong> slider to adjust the water level (H)</li>
                        <li>Fine-tune the head using the +/- buttons for precise measurements</li>
                        <li>Select different notch angles from the dropdown</li>
                        <li>Click <strong>Start Experiment</strong> to begin measurements</li>
                        <li>Observe the water level (H) in the visualization</li>
                        <li>View the calculated discharge rate (Q) in the right panel</li>
                        <li>Click <strong>Record Data</strong> to save measurements</li>
                        <li>Use <strong>Reset</strong> to clear the current experiment</li>
                    </ol>
                    
                    <h4 class="font-medium mt-4">Understanding the Results</h4>
                    <p>The graph shows the relationship between head (H) and discharge (Q). For a V-notch weir, this follows a Q ∝ H<sup>5/2</sup> relationship.</p>
                    <p>The discharge coefficient (C<sub>d</sub>) accounts for real-world effects like viscosity and surface tension.</p>
                    
                    <h4 class="font-medium mt-4">Learning Objectives</h4>
                    <ul class="list-disc pl-5 space-y-1">
                        <li>Understand the principle of flow measurement using a V-notch weir</li>
                        <li>Learn the relationship between head and discharge</li>
                        <li>Observe how notch angle affects the flow rate</li>
                        <li>Practice experimental data collection and analysis</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Voice Control Panel -->
    <div id="voicePanel" class="fixed top-4 left-4 bg-white rounded-lg shadow-lg p-4 border-2 border-purple-300 hidden z-40">
        <div class="flex items-center justify-between mb-3">
            <h4 class="font-semibold text-purple-800">🎤 Voice Assistant</h4>
            <button id="closeVoicePanel" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="space-y-2">
            <div class="flex items-center space-x-2">
                <button id="playVoiceBtn" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-sm">
                    <i class="fas fa-play"></i> Play
                </button>
                <button id="pauseVoiceBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-sm">
                    <i class="fas fa-pause"></i> Pause
                </button>
                <button id="stopVoiceBtn" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-sm">
                    <i class="fas fa-stop"></i> Stop
                </button>
            </div>
            <div class="flex items-center space-x-2">
                <label class="text-sm">Speed:</label>
                <input type="range" id="voiceSpeed" min="0.5" max="2" step="0.1" value="1" class="w-16">
                <span id="speedValue" class="text-xs">1.0x</span>
            </div>
            <div class="text-xs text-gray-600">
                <div id="voiceStatus">Ready to guide you!</div>
            </div>
        </div>
    </div>

    <!-- Welcome Modal -->
    <div id="welcomeModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md p-8 text-center relative">
            <h2 class="text-2xl font-bold mb-4 text-blue-700">Welcome to the Virtual Fluid Mechanics Lab!</h2>
            <p class="mb-6 text-gray-700">This simulation lets you explore flow rate measurement using a V-notch weir. Adjust the controls, collect data, and visualize the relationship between head and discharge.<br><br><span class="font-semibold text-blue-600">Ready to begin?</span></p>
            <div class="mb-4">
                <label class="inline-flex items-center">
                    <input type="checkbox" id="enableVoice" class="form-checkbox" checked>
                    <span class="ml-2 text-sm">🎤 Enable voice guidance</span>
                </label>
            </div>
            <button id="welcomeStartBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md text-lg font-semibold shadow">
                Start Experiment
            </button>
        </div>
    </div>

    <!-- Introduction Modal -->
    <div id="introModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-md p-8 text-center relative">
            <h2 class="text-2xl font-bold mb-4 text-blue-700">Set Initial Parameters</h2>
            <form id="introForm" class="mb-6 space-y-4">
                <div class="flex flex-col items-start">
                    <label for="introHead" class="font-medium text-gray-700 mb-1">Initial Head (H) [0.10 - 0.80 m]:</label>
                    <input id="introHead" type="number" min="0.10" max="0.80" step="0.01" value="0.30" class="w-full border border-gray-300 rounded px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-400" />
                </div>
                <div class="flex flex-col items-start">
                    <label for="introAngle" class="font-medium text-gray-700 mb-1">Notch Angle (θ):</label>
                    <select id="introAngle" class="w-full border border-gray-300 rounded px-3 py-1 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="30">30°</option>
                        <option value="45">45°</option>
                        <option value="60" selected>60°</option>
                        <option value="90">90°</option>
                        <option value="120">120°</option>
                    </select>
                </div>
            </form>
            <button id="startIntroBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-md text-lg font-semibold shadow">
                Continue
            </button>
        </div>
    </div>
    
    <script>
        // DOM Elements
        const headControlSlider = document.getElementById('headControl');
        const fineTuneMinusBtn = document.getElementById('fineTuneMinus');
        const fineTunePlusBtn = document.getElementById('fineTunePlus');
        const notchAngleSelect = document.getElementById('notchAngle');
        const autoCalculateCheckbox = document.getElementById('autoCalculate');
        const startBtn = document.getElementById('startBtn');
        const addDataBtn = document.getElementById('addDataBtn');
        const resetBtn = document.getElementById('resetBtn');
        const exportDataBtn = document.getElementById('exportDataBtn');
        const clearDataBtn = document.getElementById('clearDataBtn');
        const waterElement = document.getElementById('water');
        const hValueElement = document.getElementById('hValue');
        const displayAngle = document.getElementById('displayAngle');
        const displayH = document.getElementById('displayH');
        const theoreticalQ = document.getElementById('theoreticalQ');
        const calculatedQ = document.getElementById('calculatedQ');
        const dataTable = document.getElementById('dataTable');
        const helpBtn = document.getElementById('helpBtn');
        const helpModal = document.getElementById('helpModal');
        const closeHelp = document.getElementById('closeHelp');
        
        // Experiment state
        let experimentRunning = false;
        let runCount = 0;
        let dataPoints = [];
        
        // Initialize Chart
        const ctx = document.getElementById('resultsChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'H vs Q',
                    data: [],
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1,
                    pointRadius: 6,
                    showLine: true,
                    fill: false,
                    tension: 0,
                    borderDash: [],
                    borderWidth: 2,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        title: {
                            display: true,
                            text: 'Head (H) in meters'
                        },
                        min: 0,
                        max: 1
                    },
                    y: {
                        title: {
                            display: true,
                            text: 'Discharge (Q) in m³/s'
                        },
                        min: 0,
                        max: 0.05
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `H: ${context.parsed.x.toFixed(3)} m, Q: ${context.parsed.y.toFixed(5)} m³/s`;
                            }
                        }
                    }
                }
            }
        });
        
        // Update water level based on head control
        function updateWaterLevel() {
            const sliderValue = parseInt(headControlSlider.value);
            // Map slider (10-80) to water height (10%-80% of container)
            waterElement.style.height = `${sliderValue}%`;
            
            // Calculate actual head in meters (0.1m to 0.8m)
            const head = (0.1 + (sliderValue * 0.01)).toFixed(3);
            hValueElement.textContent = head;
            displayH.textContent = `${head} m`;
            
            if (experimentRunning && autoCalculateCheckbox.checked) {
                calculateDischarge(head);
            }
        }
        
        // Calculate discharge based on current parameters
        function calculateDischarge(head) {
            const angle = parseInt(notchAngleSelect.value);
            const headValue = parseFloat(head);
            
            // Convert angle to radians
            const angleRad = angle * Math.PI / 180;
            
            // Typical discharge coefficient for V-notch
            const Cd = 0.62;
            
            // Calculate discharge (Q = (8/15) × Cd × √(2g) × tan(θ/2) × H^(5/2))
            const Q = (8/15) * Cd * Math.sqrt(2 * 9.81) * Math.tan(angleRad/2) * Math.pow(headValue, 2.5);
            
            // Update display
            theoreticalQ.innerHTML = `Q = (8/15) × C<sub>d</sub> × √(2g) × tan(${angle}°/2) × H<sup>5/2</sup>`;
            calculatedQ.textContent = Q.toFixed(5) + " m³/s";
            
            return Q;
        }
        
        // Add data point to table and chart
        function addDataPoint() {
            if (!experimentRunning) {
                alert("Please start the experiment first!");
                return;
            }
            
            const head = parseFloat(hValueElement.textContent);
            const angle = parseInt(notchAngleSelect.value);
            const Q = calculateDischarge(head);
            
            runCount++;
            const newDataPoint = {x: head, y: Q, angle: angle};
            dataPoints.push(newDataPoint);
            
            // Update table
            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td class="px-2 py-1 border">${runCount}</td>
                <td class="px-2 py-1 border">${head.toFixed(3)}</td>
                <td class="px-2 py-1 border">${angle}°</td>
                <td class="px-2 py-1 border">${Q.toFixed(5)}</td>
                <td class="px-2 py-1 border text-center">
                    <button class="delete-btn text-red-600 hover:text-red-800" data-index="${runCount-1}">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
            dataTable.appendChild(newRow);
            
            // Add event listener to delete button
            newRow.querySelector('.delete-btn').addEventListener('click', function() {
                const index = parseInt(this.getAttribute('data-index'));
                deleteDataPoint(index);
            });
            
            // Update chart
            chart.data.datasets[0].data = dataPoints.map(point => ({x: point.x, y: point.y}));
            
            // Adjust chart scales if needed
            const maxH = Math.max(...dataPoints.map(p => p.x), 0.8);
            const maxQ = Math.max(...dataPoints.map(p => p.y), 0.05);
            
            chart.options.scales.x.max = Math.max(maxH * 1.1, 1);
            chart.options.scales.y.max = Math.max(maxQ * 1.1, 0.05);
            chart.update();
        }
        
        // Delete a data point
        function deleteDataPoint(index) {
            dataPoints.splice(index, 1);
            runCount--;
            
            // Rebuild table
            dataTable.innerHTML = `
                <tr class="bg-purple-100">
                    <th class="px-2 py-1 border">Run</th>
                    <th class="px-2 py-1 border">H (m)</th>
                    <th class="px-2 py-1 border">θ (°)</th>
                    <th class="px-2 py-1 border">Q (m³/s)</th>
                    <th class="px-2 py-1 border">Action</th>
                </tr>
            `;
            
            // Add remaining points back to table
            dataPoints.forEach((point, i) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-2 py-1 border">${i+1}</td>
                    <td class="px-2 py-1 border">${point.x.toFixed(3)}</td>
                    <td class="px-2 py-1 border">${point.angle}°</td>
                    <td class="px-2 py-1 border">${point.y.toFixed(5)}</td>
                    <td class="px-2 py-1 border text-center">
                        <button class="delete-btn text-red-600 hover:text-red-800" data-index="${i}">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                dataTable.appendChild(row);
                
                // Add event listener to delete button
                row.querySelector('.delete-btn').addEventListener('click', function() {
                    const idx = parseInt(this.getAttribute('data-index'));
                    deleteDataPoint(idx);
                });
            });
            
            // Update chart
            chart.data.datasets[0].data = dataPoints.map(point => ({x: point.x, y: point.y}));
            
            // Adjust chart scales if needed
            const maxH = dataPoints.length > 0 ? Math.max(...dataPoints.map(p => p.x)) : 0.8;
            const maxQ = dataPoints.length > 0 ? Math.max(...dataPoints.map(p => p.y)) : 0.05;
            
            chart.options.scales.x.max = Math.max(maxH * 1.1, 1);
            chart.options.scales.y.max = Math.max(maxQ * 1.1, 0.05);
            chart.update();
        }
        
        // Export data as CSV
        function exportData() {
            if (dataPoints.length === 0) {
                alert("No data to export!");
                return;
            }
            
            let csvContent = "Run,H (m),θ (°),Q (m³/s)\n";
            
            dataPoints.forEach((point, i) => {
                csvContent += `${i+1},${point.x.toFixed(3)},${point.angle},${point.y.toFixed(5)}\n`;
            });
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', 'v-notch_data.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Clear all data
        function clearData() {
            if (confirm("Are you sure you want to clear all data?")) {
                dataPoints = [];
                runCount = 0;
                dataTable.innerHTML = `
                    <tr class="bg-purple-100">
                        <th class="px-2 py-1 border">Run</th>
                        <th class="px-2 py-1 border">H (m)</th>
                        <th class="px-2 py-1 border">θ (°)</th>
                        <th class="px-2 py-1 border">Q (m³/s)</th>
                        <th class="px-2 py-1 border">Action</th>
                    </tr>
                `;
                chart.data.datasets[0].data = [];
                chart.options.scales.x.max = 1;
                chart.options.scales.y.max = 0.05;
                chart.update();
            }
        }
        
        // Reset experiment
        function resetExperiment() {
            experimentRunning = false;
            startBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Start Simulation';
            startBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
            startBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            
            // Reset to default values
            headControlSlider.value = 30;
            notchAngleSelect.value = 60;
            updateWaterLevel();
            displayAngle.textContent = '60°';
        }
        
        // Event Listeners
        headControlSlider.addEventListener('input', updateWaterLevel);
        
        fineTuneMinusBtn.addEventListener('click', () => {
            headControlSlider.value = parseInt(headControlSlider.value) - 1;
            updateWaterLevel();
        });
        
        fineTunePlusBtn.addEventListener('click', () => {
            headControlSlider.value = parseInt(headControlSlider.value) + 1;
            updateWaterLevel();
        });
        
        notchAngleSelect.addEventListener('change', () => {
            const angle = parseInt(notchAngleSelect.value);
            displayAngle.textContent = `${angle}°`;
            if (experimentRunning && autoCalculateCheckbox.checked) {
                const head = hValueElement.textContent;
                calculateDischarge(head);
            }
        });
        
        autoCalculateCheckbox.addEventListener('change', () => {
            if (autoCalculateCheckbox.checked && experimentRunning) {
                const head = hValueElement.textContent;
                calculateDischarge(head);
            }
        });
        
        startBtn.addEventListener('click', () => {
            experimentRunning = !experimentRunning;
            if (experimentRunning) {
                setWaterAnimationPaused(false); // Start water/molecule animation
                startBtn.innerHTML = '<i class="fas fa-pause mr-2"></i> Pause Simulation';
                startBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                startBtn.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
                // Initialize with current values
                const head = hValueElement.textContent;
                calculateDischarge(head);
                voiceAssistant.speak(VoiceMessages.simulationStarted);
            } else {
                setWaterAnimationPaused(true); // Pause water/molecule animation
                startBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Start Simulation';
                startBtn.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                startBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            }
        });
        
        addDataBtn.addEventListener('click', () => {
            const dataCount = dataPoints.length;
            addDataPoint();
            if (dataCount === 0) {
                voiceAssistant.speak("Excellent! You've recorded your first data point. Now look at the graph below - you can see your measurement plotted. Try adjusting the head and recording more points to see how the relationship pattern develops.");
            } else if (dataCount === 2) {
                voiceAssistant.speak("Great progress! You now have multiple data points. Look at your graph - notice how the points are forming a curve. This shows the relationship between head and discharge rate. The curve demonstrates that discharge increases rapidly with head, following the H to the power 2.5 relationship.");
            } else if (dataCount === 4) {
                voiceAssistant.speak("Wonderful! You're building a comprehensive dataset. Observe your graph carefully - the curved line connecting your points shows the characteristic behavior of a V-notch weir. Higher heads produce disproportionately higher discharge rates. This non-linear relationship is fundamental to weir hydraulics.");
            } else {
                voiceAssistant.speak("Data point recorded successfully! Keep watching the graph as it updates. Each new point helps define the characteristic curve more precisely. Notice how the slope of the curve changes - this indicates the sensitivity of the weir to head variations.");
            }
        });
        
        resetBtn.addEventListener('click', resetExperiment);
        
        exportDataBtn.addEventListener('click', exportData);
        
        clearDataBtn.addEventListener('click', clearData);
        
        helpBtn.addEventListener('click', () => {
            helpModal.classList.remove('hidden');
            voiceAssistant.speak(VoiceMessages.helpGuide);
        });
        
        closeHelp.addEventListener('click', () => {
            helpModal.classList.add('hidden');
        });
        
        // Close modal when clicking outside
        helpModal.addEventListener('click', (e) => {
            if (e.target === helpModal) {
                helpModal.classList.add('hidden');
            }
        });
        
        // V-Notch SVG dynamic angle
        function updateVNotchAngle(angleDeg) {
            const svg = document.getElementById('vNotchSVG');
            const poly = document.getElementById('vNotchPolygon');
            if (!svg || !poly) return;
            // SVG size
            const w = 128, h = 128;
            // Apex at bottom center
            const apexX = w / 2, apexY = h;
            // Calculate left and right points based on angle
            const theta = angleDeg * Math.PI / 180;
            const halfBase = Math.tan(theta/2) * (h-8); // 8px margin at top
            let x1 = apexX - halfBase;
            let x2 = apexX + halfBase;
            // Clamp to SVG bounds
            x1 = Math.max(0, Math.min(w, x1));
            x2 = Math.max(0, Math.min(w, x2));
            const yTop = 8;
            // Points: left top, right top, apex
            const points = `${x1},${yTop} ${x2},${yTop} ${apexX},${apexY}`;
            poly.setAttribute('points', points);
        }

        // Initial V-notch angle
        updateVNotchAngle(parseInt(document.getElementById('notchAngle').value));

        // Update V-notch when angle changes
        notchAngleSelect.addEventListener('change', () => {
            const angle = parseInt(notchAngleSelect.value);
            displayAngle.textContent = `${angle}°`;
            updateVNotchAngle(angle);
            if (experimentRunning && autoCalculateCheckbox.checked) {
                const head = hValueElement.textContent;
                calculateDischarge(head);
                voiceAssistant.speak(`Notch angle changed to ${angle} degrees. Observe how this affects the discharge calculation.`);
            }
        });

        // Welcome and Parameter Modals Logic
        const welcomeModal = document.getElementById('welcomeModal');
        const welcomeStartBtn = document.getElementById('welcomeStartBtn');
        const introModal = document.getElementById('introModal');
        const startIntroBtn = document.getElementById('startIntroBtn');
        const introHead = document.getElementById('introHead');
        const introAngle = document.getElementById('introAngle');

        // Show welcome modal on load and pause water
        window.addEventListener('DOMContentLoaded', () => {
            welcomeModal.classList.remove('hidden');
            setTimeout(initMolecules, 400);
            setWaterAnimationPaused(true);
            // Welcome voice message
            setTimeout(() => {
                voiceAssistant.speak(VoiceMessages.welcome);
            }, 1000);
        });

        // On welcome modal button, show parameter modal (water still paused)
        welcomeStartBtn.addEventListener('click', () => {
            welcomeModal.classList.add('hidden');
            introModal.classList.remove('hidden');
            voiceAssistant.speak(VoiceMessages.parameterSetup);
        });

        // On parameter modal button, set parameters and hide, but keep water paused
        startIntroBtn.addEventListener('click', () => {
            // Clamp and set head value
            let headVal = parseFloat(introHead.value);
            if (isNaN(headVal) || headVal < 0.10) headVal = 0.10;
            if (headVal > 0.80) headVal = 0.80;
            // Map head to slider value (slider 10-80 for 0.10-0.80)
            const sliderVal = Math.round((headVal - 0.10) * 100);
            headControlSlider.value = sliderVal;
            updateWaterLevel();
            // Set angle
            notchAngleSelect.value = introAngle.value;
            displayAngle.textContent = `${introAngle.value}°`;
            updateVNotchAngle(parseInt(introAngle.value));
            introModal.classList.add('hidden');
            setWaterAnimationPaused(true); // keep paused until Start Simulation
            voiceAssistant.speak(VoiceMessages.experimentReady);
        });

        // --- Water Animation Control and Molecule Animation ---
        let moleculesAnimationActive = false;
        const moleculeContainer = document.getElementById('moleculeContainer');
        const moleculeCount = 18;
        const molecules = [];
        const waterWidth = moleculeContainer.offsetWidth || 400; // fallback width
        const waterHeight = moleculeContainer.offsetHeight || 80; // fallback height

        function setWaterAnimationPaused(paused) {
            // Pause/resume CSS animations
            document.getElementById('water').classList.toggle('paused-animation', paused);
            document.querySelectorAll('.horizontal-flow').forEach(el => el.classList.toggle('paused-animation', paused));
            // Pause/resume molecules
            moleculesAnimationActive = !paused;
        }

        function createMolecule() {
            const molecule = document.createElement('div');
            molecule.className = 'water-molecule';
            const width = 7 + Math.random() * 4; // 7-11px
            const height = 4 + Math.random() * 2.5; // 4-6.5px
            const top = Math.random() * 60 + 15; // stay away from edges
            molecule.style.width = `${width}px`;
            molecule.style.height = `${height}px`;
            molecule.style.top = `${top}%`;
            molecule.style.left = `${Math.random() * 100}%`;
            molecule.style.opacity = 0.32;
            molecule.style.zIndex = 2;
            moleculeContainer.appendChild(molecule);
            return {
                el: molecule,
                width,
                height,
                top,
                left: Math.random() * 100,
                speed: 0.13 + Math.random() * 0.13
            };
        }

        function animateMolecules() {
            if (moleculesAnimationActive) {
                molecules.forEach(mol => {
                    mol.left += mol.speed;
                    if (mol.left > 100) mol.left = -5;
                    mol.el.style.left = `${mol.left}%`;
                });
            }
            requestAnimationFrame(animateMolecules);
        }

        function initMolecules() {
            for (let i = 0; i < moleculeCount; i++) {
                molecules.push(createMolecule());
            }
            animateMolecules();
        }

        // === Voice Assistant System ===
        class VoiceAssistant {
            constructor() {
                this.synth = window.speechSynthesis;
                this.voice = null;
                this.isEnabled = true;
                this.isSpeaking = false;
                this.currentUtterance = null;
                this.speed = 1.0;
                this.initVoice();
                this.setupEventListeners();
            }

            initVoice() {
                // Wait for voices to load
                const setVoice = () => {
                    const voices = this.synth.getVoices();
                    // Prefer female voices
                    this.voice = voices.find(voice => 
                        voice.name.toLowerCase().includes('female') ||
                        voice.name.toLowerCase().includes('samantha') ||
                        voice.name.toLowerCase().includes('karen') ||
                        voice.name.toLowerCase().includes('anna') ||
                        voice.name.toLowerCase().includes('zira') ||
                        (voice.lang.startsWith('en') && voice.gender === 'female')
                    ) || voices.find(voice => voice.lang.startsWith('en')) || voices[0];
                };

                if (this.synth.getVoices().length > 0) {
                    setVoice();
                } else {
                    this.synth.addEventListener('voiceschanged', setVoice);
                }
            }

            setupEventListeners() {
                document.getElementById('voiceSpeed').addEventListener('input', (e) => {
                    this.speed = parseFloat(e.target.value);
                    document.getElementById('speedValue').textContent = `${this.speed}x`;
                });
            }

            speak(text, options = {}) {
                if (!this.isEnabled) return;

                this.stop(); // Stop any current speech

                this.currentUtterance = new SpeechSynthesisUtterance(text);
                this.currentUtterance.voice = this.voice;
                this.currentUtterance.rate = this.speed;
                this.currentUtterance.pitch = 1.1; // Slightly higher pitch for friendliness
                this.currentUtterance.volume = 0.8;

                this.currentUtterance.onstart = () => {
                    this.isSpeaking = true;
                    document.getElementById('voiceStatus').textContent = 'Speaking...';
                };

                this.currentUtterance.onend = () => {
                    this.isSpeaking = false;
                    document.getElementById('voiceStatus').textContent = 'Ready to guide you!';
                    if (options.callback) options.callback();
                };

                this.currentUtterance.onerror = () => {
                    this.isSpeaking = false;
                    document.getElementById('voiceStatus').textContent = 'Voice error occurred';
                };

                this.synth.speak(this.currentUtterance);
            }

            pause() {
                if (this.isSpeaking) {
                    this.synth.pause();
                    document.getElementById('voiceStatus').textContent = 'Paused';
                }
            }

            resume() {
                if (this.synth.paused) {
                    this.synth.resume();
                    document.getElementById('voiceStatus').textContent = 'Speaking...';
                }
            }

            stop() {
                this.synth.cancel();
                this.isSpeaking = false;
                document.getElementById('voiceStatus').textContent = 'Stopped';
            }

            enable() { this.isEnabled = true; }
            disable() { this.isEnabled = false; }
        }

        // Voice Messages Library
        const VoiceMessages = {
            welcome: "Welcome to the Virtual Fluid Mechanics Laboratory! I'm your voice assistant, and I'll guide you through the V-notch weir flow measurement experiment. This simulation will help you understand the relationship between water head and discharge rate. Are you ready to begin this exciting journey in hydraulic engineering?",
            
            parameterSetup: "Great! Now let's set up your initial experiment parameters. You can choose the starting water head between 0.1 and 0.8 meters, and select the V-notch angle from 30 to 120 degrees. These parameters will affect the flow rate through the weir. Take your time to choose values that interest you.",
            
            experimentReady: "Perfect! Your experiment setup is complete. You can see the V-notch weir in the channel, with water ready to flow. Notice the measurement scale on the right showing the water head, and the digital displays showing real-time values. When you're ready, click the Start Simulation button to begin the water flow.",
            
            simulationStarted: "Excellent! The simulation has started. Watch as the water flows horizontally through the channel and over the V-notch weir. You can see the water molecules moving, representing the actual flow. The discharge rate is calculated automatically using the V-notch weir equation.",
            
            adjustingParameters: "You can adjust the water head using the slider or fine-tune buttons, and change the notch angle from the dropdown. Notice how these changes affect the calculated discharge rate. This demonstrates the relationship Q equals 8 over 15 times C d times square root of 2g times tangent theta over 2 times H to the power 5 over 2.",
            
            recordingData: "Great! You can record data points by clicking the Record Data button. Each measurement will be added to the data table and plotted on the graph. Try taking measurements at different head values to see the characteristic curve of the V-notch weir.",
            
            analyzingResults: "Look at your graph! The relationship between head and discharge follows a power curve, specifically Q is proportional to H to the power 2.5. This is the fundamental characteristic of triangular weirs. The steeper the curve, the more sensitive the weir is to changes in head.",
            
            experimentComplete: "Congratulations! You've successfully completed the V-notch weir experiment. You've learned how to measure flow rates using a triangular weir, understand the relationship between head and discharge, and collected valuable data. This knowledge is essential in hydraulic engineering and water resource management.",
            
            helpGuide: "If you need help at any time, remember that you can adjust the water level with the head control slider, change the V-notch angle, start and pause the simulation, record data points, and view the relationship graph. I'm here to guide you through each step!",
            
            errorGuidance: "Don't worry if something doesn't seem right. You can always reset the experiment and start over. Make sure to set reasonable parameter values and take multiple measurements for better understanding of the flow behavior."
        };

        // Initialize Voice Assistant
        const voiceAssistant = new VoiceAssistant();

        // Voice Control Event Listeners
        document.getElementById('voiceBtn').addEventListener('click', () => {
            document.getElementById('voicePanel').classList.toggle('hidden');
        });

        document.getElementById('closeVoicePanel').addEventListener('click', () => {
            document.getElementById('voicePanel').classList.add('hidden');
        });

        document.getElementById('playVoiceBtn').addEventListener('click', () => {
            voiceAssistant.resume();
        });

        document.getElementById('pauseVoiceBtn').addEventListener('click', () => {
            voiceAssistant.pause();
        });

        document.getElementById('stopVoiceBtn').addEventListener('click', () => {
            voiceAssistant.stop();
        });

        document.getElementById('enableVoice').addEventListener('change', (e) => {
            if (e.target.checked) {
                voiceAssistant.enable();
            } else {
                voiceAssistant.disable();
                voiceAssistant.stop();
            }
        });

        // Add voice guidance for parameter changes
        headControlSlider.addEventListener('change', () => {
            if (experimentRunning) {
                voiceAssistant.speak("Head adjusted. Notice how the discharge rate changes with the new water level.");
            }
        });

        notchAngleSelect.addEventListener('change', () => {
            const angle = parseInt(notchAngleSelect.value);
            displayAngle.textContent = `${angle}°`;
            updateVNotchAngle(angle);
            if (experimentRunning && autoCalculateCheckbox.checked) {
                const head = hValueElement.textContent;
                calculateDischarge(head);
                voiceAssistant.speak(`Notch angle changed to ${angle} degrees. Observe how this affects the discharge calculation.`);
            }
        });
    </script>
</body>
</html>
